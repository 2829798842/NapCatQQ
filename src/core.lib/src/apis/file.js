const _0x54028d=_0x2e35;(function(_0xe1eb9a,_0x49e4bc){const _0x2c344f=_0x2e35,_0x33693e=_0xe1eb9a();while(!![]){try{const _0x1da01d=-parseInt(_0x2c344f(0x17f))/0x1*(-parseInt(_0x2c344f(0x165))/0x2)+parseInt(_0x2c344f(0x15e))/0x3+-parseInt(_0x2c344f(0x198))/0x4*(-parseInt(_0x2c344f(0x164))/0x5)+parseInt(_0x2c344f(0x192))/0x6+parseInt(_0x2c344f(0x15b))/0x7*(-parseInt(_0x2c344f(0x16b))/0x8)+-parseInt(_0x2c344f(0x19d))/0x9*(-parseInt(_0x2c344f(0x175))/0xa)+-parseInt(_0x2c344f(0x15c))/0xb;if(_0x1da01d===_0x49e4bc)break;else _0x33693e['push'](_0x33693e['shift']());}catch(_0x3bf5a6){_0x33693e['push'](_0x33693e['shift']());}}}(_0xc4ca,0x38df0));import{ElementType,IMAGE_HTTP_HOST,IMAGE_HTTP_HOST_NT}from'@/core/entities';import _0x384e58 from'path';import _0x38d028 from'fs';import _0x55c1e6 from'fs/promises';import{logDebug}from'@/common/utils/log';import{napCatCore}from'@/core';import{calculateFileMD5}from'@/common/utils/file';import*as _0x22c686 from'file-type';function _0x2e35(_0x24819a,_0x32aaee){const _0xc4ca72=_0xc4ca();return _0x2e35=function(_0x2e3598,_0x171195){_0x2e3598=_0x2e3598-0x156;let _0x5d8dab=_0xc4ca72[_0x2e3598];return _0x5d8dab;},_0x2e35(_0x24819a,_0x32aaee);}import{MsgListener}from'@/core/listeners';import _0x5a34ef from'image-size';import{sessionConfig}from'@/core/sessionConfig';import{randomUUID}from'crypto';import{rkeyManager}from'../utils/rkey';import{AsyncQueue}from'@/common/utils/AsyncQueue';const getRKeyTaskQueue=new AsyncQueue(),downloadMediaTasks=new Map(),downloadMediaListener=new MsgListener();downloadMediaListener['onRichMediaDownloadComplete']=_0x3c66e2=>{const _0x230477=_0x2e35;for(const [_0x4ce407,_0x102472]of downloadMediaTasks){_0x102472(_0x3c66e2),downloadMediaTasks[_0x230477(0x16a)](_0x4ce407);}},setTimeout(()=>{const _0x501c0a=_0x2e35;napCatCore[_0x501c0a(0x19e)](()=>{napCatCore['addListener'](downloadMediaListener);});},0x64);function _0xc4ca(){const _0x383016=['getStorageCleanService','clearChatCacheInfo','includes','util','520830GFNAVF','fileUuid','addCacheScannedPaths','miGIM','addCacheScanedPaths','peerUid','8HiaCkF','kBEyf','getRichMediaFilePathForGuild','getHotUpdateCachePath','CKunh','9nWUdcH','onLoginSuccess','getCacheSessionPathList','getChatCacheList','clearCacheDataByKeys','unlink','ext','图片url获取失败','nZDew','1687GPWGsJ','1276429tKMWCU','set','218235kxUiuG','tmp','KlVsb','startsWith','uploadFile','urlResult','698465HtErBJ','206lUlLZQ','RPYbj','setCacheSilentScan','defaultFileDownloadPath','getMsgService','delete','6544gPEDNd','downloadMedia','existsSync','session','getVideoUrl','eWkWX','kvOnP','toUpperCase','filePath','url','78930XYaGfR','getFileSize','getChatCacheInfo','scanCache','WmoVg','clearChatCache','join','RBIZK','getFileCacheInfo','group_rkey','964VwAfAa','getDesktopTmpPath','copyFile','getRkey','clearCache','WzIXK','hRUIe','JbyyA','msgId','gIGRX','basename','indexOf','RNeyb','originImageUrl','下载超时'];_0xc4ca=function(){return _0x383016;};return _0xc4ca();}export class NTQQFileApi{static async['getFileType'](_0x9449fe){return _0x22c686['fileTypeFromFile'](_0x9449fe);}static async['copyFile'](_0x42becc,_0x29c235){const _0x268bfa=_0x2e35;await napCatCore[_0x268bfa(0x191)][_0x268bfa(0x181)](_0x42becc,_0x29c235);}static async['getFileSize'](_0x59dbc1){const _0x20fe61=_0x2e35;return await napCatCore[_0x20fe61(0x191)][_0x20fe61(0x176)](_0x59dbc1);}static async[_0x54028d(0x16f)](_0x21cda4,_0xfe499f){const _0x15ba0d=_0x54028d;return(await napCatCore[_0x15ba0d(0x16e)]['getRichMediaService']()['getVideoPlayUrlV2']({'chatType':_0x21cda4['chatType'],'peerUid':_0x21cda4[_0x15ba0d(0x197)],'guildId':'0'},_0x21cda4[_0x15ba0d(0x187)],_0xfe499f['elementId'],0x0,{'downSourceType':0x1,'triggerType':0x1}))[_0x15ba0d(0x163)]['domainUrl'][0x0][_0x15ba0d(0x174)];}static async[_0x54028d(0x162)](_0xd1f2c,_0x2cd14c=ElementType['PIC'],_0x2dd2ea=0x0){const _0x4b1822=_0x54028d,_0x558454={'RPYbj':function(_0x5b98cf,_0x477f0f){return _0x5b98cf(_0x477f0f);},'RBIZK':function(_0x4a6c9f,_0x1010c0){return _0x4a6c9f+_0x1010c0;},'miGIM':function(_0xae3ee2,_0x341889){return _0xae3ee2===_0x341889;}},_0x1f67ba=await _0x558454[_0x4b1822(0x166)](calculateFileMD5,_0xd1f2c);let _0x43faaf=(await NTQQFileApi['getFileType'](_0xd1f2c))?.[_0x4b1822(0x158)]||'';_0x43faaf&&(_0x43faaf=_0x558454[_0x4b1822(0x17c)]('.',_0x43faaf));let _0x3f24ff=''+_0x384e58[_0x4b1822(0x189)](_0xd1f2c);_0x558454[_0x4b1822(0x195)](_0x3f24ff[_0x4b1822(0x18a)]('.'),-0x1)&&(_0x3f24ff+=_0x43faaf);const _0x31d481=napCatCore[_0x4b1822(0x16e)][_0x4b1822(0x169)]()[_0x4b1822(0x19a)]({'md5HexStr':_0x1f67ba,'fileName':_0x3f24ff,'elementType':_0x2cd14c,'elementSubType':_0x2dd2ea,'thumbSize':0x0,'needCreate':!![],'downloadType':0x1,'file_uuid':''});await NTQQFileApi[_0x4b1822(0x181)](_0xd1f2c,_0x31d481);const _0x1dd653=await NTQQFileApi[_0x4b1822(0x176)](_0xd1f2c);return{'md5':_0x1f67ba,'fileName':_0x3f24ff,'path':_0x31d481,'fileSize':_0x1dd653,'ext':_0x43faaf};}static async[_0x54028d(0x16c)](_0x43aae0,_0x10ef48,_0x23ee0b,_0x3787a7,_0x52e084,_0xc449fd,_0x524fbf=0x3e8*0x3c*0x2,_0x3a4f3f=![]){const _0x5a7e0d=_0x54028d,_0x31de45={'cesyp':function(_0x160ed9,_0xd3601b){return _0x160ed9===_0xd3601b;},'dPKYO':function(_0xfdb0f7,_0x3a1985){return _0xfdb0f7(_0x3a1985);},'YeOqB':function(_0x575ca8,_0x424b18){return _0x575ca8(_0x424b18);},'WzIXK':_0x5a7e0d(0x18d),'hRUIe':function(_0x63e367){return _0x63e367();},'zLaPr':function(_0x18b12a,_0x212314,_0x80ff72){return _0x18b12a(_0x212314,_0x80ff72);}};if(_0xc449fd&&_0x38d028[_0x5a7e0d(0x16d)](_0xc449fd)){if(_0x3a4f3f)try{await _0x55c1e6[_0x5a7e0d(0x157)](_0xc449fd);}catch(_0x442ea8){}else return _0xc449fd;}return new Promise((_0x4ae424,_0x15f2fe)=>{const _0x3fe486=_0x5a7e0d;let _0x34beb3=![];const _0x56e075=_0x1fe3f9=>{const _0x265df6=_0x2e35;if(_0x31de45['cesyp'](_0x1fe3f9['msgId'],_0x43aae0)){_0x34beb3=!![];let _0x2205db=_0x1fe3f9[_0x265df6(0x173)];if(_0x2205db[_0x265df6(0x161)]('\x5c')){const _0x20e5e2=sessionConfig[_0x265df6(0x168)];_0x2205db=_0x384e58[_0x265df6(0x17b)](_0x20e5e2,_0x2205db);}_0x31de45['dPKYO'](_0x4ae424,_0x2205db);}};downloadMediaTasks[_0x3fe486(0x15d)](_0x31de45[_0x3fe486(0x185)](randomUUID),_0x56e075),_0x31de45['zLaPr'](setTimeout,()=>{const _0x353728=_0x3fe486;!_0x34beb3&&_0x31de45['YeOqB'](_0x15f2fe,_0x31de45[_0x353728(0x184)]);},_0x524fbf),napCatCore[_0x3fe486(0x16e)]['getMsgService']()['downloadRichMedia']({'fileModelId':'0','downloadSourceType':0x0,'triggerType':0x1,'msgId':_0x43aae0,'chatType':_0x10ef48,'peerUid':_0x23ee0b,'elementId':_0x3787a7,'thumbSize':0x0,'downloadType':0x1,'filePath':_0x52e084});});}static async['getImageSize'](_0x4865f7){const _0x5427ed={'nZDew':function(_0x44f7b7,_0x5d039f){return _0x44f7b7(_0x5d039f);}};return new Promise((_0xe4b194,_0x4c8a20)=>{const _0x545ac9={'RNeyb':function(_0x39e54c,_0x2d922a){const _0x4f8668=_0x2e35;return _0x5427ed[_0x4f8668(0x15a)](_0x39e54c,_0x2d922a);}};_0x5a34ef(_0x4865f7,(_0x5c24c2,_0x54f004)=>{const _0x56503f=_0x2e35;_0x5c24c2?_0x545ac9[_0x56503f(0x18b)](_0x4c8a20,_0x5c24c2):_0xe4b194(_0x54f004);});});}static async['getImageUrl'](_0x311fc2,_0x68d353){const _0x3098bf=_0x54028d,_0x5ab9b4={'JbyyA':'/download','xFLpX':'&rkey=','kvOnP':function(_0x2edeb6,_0x364e13){return _0x2edeb6+_0x364e13;},'CKunh':function(_0x1ec38b,_0x52fed5){return _0x1ec38b+_0x52fed5;},'kBEyf':function(_0xf74806,_0x2d0ab9){return _0xf74806+_0x2d0ab9;},'eWkWX':function(_0x4acbbc,_0x31ef76){return _0x4acbbc||_0x31ef76;},'gIGRX':function(_0x17acf9,_0x4b4db5){return _0x17acf9||_0x4b4db5;},'KlVsb':function(_0x18c2c7,_0x5edf1b,_0x3e0261){return _0x18c2c7(_0x5edf1b,_0x3e0261);},'WmoVg':_0x3098bf(0x159)};if(!_0x311fc2)return'';const _0x1dc31e=_0x311fc2[_0x3098bf(0x18c)],_0x2c272f=_0x311fc2['md5HexStr'],_0x512d7b=_0x311fc2['md5HexStr'],_0x205134=_0x311fc2[_0x3098bf(0x193)];if(_0x1dc31e){if(_0x1dc31e[_0x3098bf(0x161)](_0x5ab9b4[_0x3098bf(0x186)])){if(_0x1dc31e[_0x3098bf(0x190)](_0x5ab9b4['xFLpX']))return _0x5ab9b4[_0x3098bf(0x171)](IMAGE_HTTP_HOST_NT,_0x1dc31e);const _0x102b79=await rkeyManager[_0x3098bf(0x182)](),_0x19c532=_0x68d353?_0x102b79['private_rkey']:_0x102b79[_0x3098bf(0x17e)];return _0x5ab9b4[_0x3098bf(0x19c)](IMAGE_HTTP_HOST_NT+_0x1dc31e,''+_0x19c532);}else return _0x5ab9b4[_0x3098bf(0x199)](IMAGE_HTTP_HOST,_0x1dc31e);}else{if(_0x5ab9b4[_0x3098bf(0x170)](_0x512d7b,_0x2c272f))return IMAGE_HTTP_HOST+'/gchatpic_new/0/0-0-'+_0x5ab9b4[_0x3098bf(0x188)](_0x512d7b,_0x2c272f)[_0x3098bf(0x172)]()+'/0';}return _0x5ab9b4[_0x3098bf(0x160)](logDebug,_0x5ab9b4[_0x3098bf(0x179)],_0x311fc2),'';}}export class NTQQFileCacheApi{static async[_0x54028d(0x167)](_0x4fa042=!![]){return'';}static[_0x54028d(0x19f)](){return'';}static[_0x54028d(0x183)](_0xeb4253=[_0x54028d(0x15f),'hotUpdate']){const _0x149667=_0x54028d;return napCatCore[_0x149667(0x16e)][_0x149667(0x18e)]()[_0x149667(0x156)](_0xeb4253);}static[_0x54028d(0x194)](_0x4768aa={}){const _0x51c047=_0x54028d;return napCatCore[_0x51c047(0x16e)]['getStorageCleanService']()[_0x51c047(0x196)](_0x4768aa);}static[_0x54028d(0x178)](){const _0x135401=_0x54028d;return napCatCore['session'][_0x135401(0x18e)]()[_0x135401(0x178)]();}static[_0x54028d(0x19b)](){return'';}static[_0x54028d(0x180)](){return'';}static[_0x54028d(0x1a0)](_0x4210ad,_0x50060d=0x3e8,_0xc5b8fd=0x0){const _0x395a7a=_0x54028d;return napCatCore[_0x395a7a(0x16e)]['getStorageCleanService']()[_0x395a7a(0x177)](_0x4210ad,_0x50060d,0x1,_0xc5b8fd);}static[_0x54028d(0x17d)](_0xe0ddff,_0x18217c=0x3e8,_0x22019f){const _0x20cfaf=_0x22019f?_0x22019f:{'fileType':_0xe0ddff};}static async[_0x54028d(0x17a)](_0x35cbad=[],_0x253619=[]){const _0x53cabb=_0x54028d;return napCatCore[_0x53cabb(0x16e)][_0x53cabb(0x18e)]()[_0x53cabb(0x18f)](_0x35cbad,_0x253619);}}