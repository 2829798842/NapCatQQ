const _0x568a69=_0x3eb4;(function(_0x46fe89,_0x55728a){const _0xf69a30=_0x3eb4,_0x5a1b50=_0x46fe89();while(!![]){try{const _0x59e286=-parseInt(_0xf69a30(0xf3))/0x1+parseInt(_0xf69a30(0x121))/0x2*(-parseInt(_0xf69a30(0xfb))/0x3)+-parseInt(_0xf69a30(0x120))/0x4*(-parseInt(_0xf69a30(0x101))/0x5)+-parseInt(_0xf69a30(0x127))/0x6*(-parseInt(_0xf69a30(0xed))/0x7)+parseInt(_0xf69a30(0x10a))/0x8*(-parseInt(_0xf69a30(0xfd))/0x9)+-parseInt(_0xf69a30(0x12c))/0xa+parseInt(_0xf69a30(0x110))/0xb;if(_0x59e286===_0x55728a)break;else _0x5a1b50['push'](_0x5a1b50['shift']());}catch(_0x585580){_0x5a1b50['push'](_0x5a1b50['shift']());}}}(_0xaff9,0xdb457));import{ElementType,IMAGE_HTTP_HOST,IMAGE_HTTP_HOST_NT}from'@/core/entities';import _0x790f6a from'path';import _0x35d4c2 from'fs';import _0x118895 from'fs/promises';function _0x3eb4(_0x3e7516,_0x300ac2){const _0xaff9d5=_0xaff9();return _0x3eb4=function(_0x3eb431,_0x57d93f){_0x3eb431=_0x3eb431-0xe4;let _0x10baa8=_0xaff9d5[_0x3eb431];return _0x10baa8;},_0x3eb4(_0x3e7516,_0x300ac2);}import{logDebug}from'@/common/utils/log';import{napCatCore}from'@/core';import{calculateFileMD5}from'@/common/utils/file';function _0xaff9(){const _0x13168e=['getVideoPlayUrlV2','getChatCacheList','session','/download','33772101sqkBvN','existsSync','yRSDO','getHotUpdateCachePath','fileUuid','md5HexStr','getCacheSessionPathList','DZkVM','group_rkey','getFileSize','join','clearChatCache','domainUrl','getFileType','getChatCacheInfo','util','49688pMCIZO','16018CtXpDB','unlink','getRichMediaService','originImageUrl','fileTypeFromFile','onLoginSuccess','97926gaRjJN','indexOf','chatType','defaultFileDownloadPath','下载超时','454250NYVcft','clearChatCacheInfo','HoDHm','addListener','addCacheScanedPaths','getStorageCleanService','ZHAsT','VlCZt','delete','fuxMQ','161lBPSKw','jxgMR','getVideoUrl','filePath','getImageUrl','guRvK','455862GrAyTg','startsWith','urlResult','onRichMediaDownloadComplete','msgId','QkJvn','getRkey','downloadRichMedia','669zeODtT','getImageSize','3213vmQIjb','url','fXgcu','getMsgService','555iuyryY','FDhXb','PIC','scanCache','图片url获取失败','includes','QrRZA','&rkey=','set','36728GHfAfc','copyFile'];_0xaff9=function(){return _0x13168e;};return _0xaff9();}import*as _0x22f14a from'file-type';import{MsgListener}from'@/core/listeners';import _0x2f74c5 from'image-size';import{sessionConfig}from'@/core/sessionConfig';import{randomUUID}from'crypto';import{rkeyManager}from'../utils/rkey';import{AsyncQueue}from'@/common/utils/AsyncQueue';const getRKeyTaskQueue=new AsyncQueue(),downloadMediaTasks=new Map(),downloadMediaListener=new MsgListener();downloadMediaListener[_0x568a69(0xf6)]=_0x1b49dd=>{const _0x3290c1=_0x568a69,_0x26de73={'HoDHm':function(_0x5c871b,_0x49e15f){return _0x5c871b(_0x49e15f);}};for(const [_0x559467,_0x300b5e]of downloadMediaTasks){_0x26de73[_0x3290c1(0xe5)](_0x300b5e,_0x1b49dd),downloadMediaTasks[_0x3290c1(0xeb)](_0x559467);}},setTimeout(()=>{const _0x37d780=_0x568a69;napCatCore[_0x37d780(0x126)](()=>{const _0x10b390=_0x37d780;napCatCore[_0x10b390(0xe6)](downloadMediaListener);});},0x64);export class NTQQFileApi{static async['getFileType'](_0x86b370){const _0x209d73=_0x568a69;return _0x22f14a[_0x209d73(0x125)](_0x86b370);}static async[_0x568a69(0x10b)](_0x4ee49a,_0x1cac59){const _0xdf37c3=_0x568a69;await napCatCore[_0xdf37c3(0x11f)]['copyFile'](_0x4ee49a,_0x1cac59);}static async[_0x568a69(0x119)](_0x57b630){const _0x3d41c9=_0x568a69;return await napCatCore['util'][_0x3d41c9(0x119)](_0x57b630);}static async[_0x568a69(0xef)](_0xd1f2fa,_0x54e273){const _0x1d9cb6=_0x568a69;return(await napCatCore['session'][_0x1d9cb6(0x123)]()[_0x1d9cb6(0x10c)]({'chatType':_0xd1f2fa[_0x1d9cb6(0x129)],'peerUid':_0xd1f2fa['peerUid'],'guildId':'0'},_0xd1f2fa[_0x1d9cb6(0xf7)],_0x54e273['elementId'],0x0,{'downSourceType':0x1,'triggerType':0x1}))[_0x1d9cb6(0xf5)][_0x1d9cb6(0x11c)][0x0][_0x1d9cb6(0xfe)];}static async['uploadFile'](_0x26eaf2,_0x335a3c=ElementType[_0x568a69(0x103)],_0x9bb05f=0x0){const _0x5246bf=_0x568a69,_0x3673bb={'VlCZt':function(_0x55c00f,_0x5a2db1){return _0x55c00f+_0x5a2db1;},'pjEME':function(_0x248a47,_0x5c8dbb){return _0x248a47===_0x5c8dbb;}},_0x2e8d7f=await calculateFileMD5(_0x26eaf2);let _0x366156=(await NTQQFileApi[_0x5246bf(0x11d)](_0x26eaf2))?.['ext']||'';_0x366156&&(_0x366156=_0x3673bb[_0x5246bf(0xea)]('.',_0x366156));let _0x581db7=''+_0x790f6a['basename'](_0x26eaf2);_0x3673bb['pjEME'](_0x581db7[_0x5246bf(0x128)]('.'),-0x1)&&(_0x581db7+=_0x366156);const _0x5008e4=napCatCore[_0x5246bf(0x10e)]['getMsgService']()['getRichMediaFilePathForGuild']({'md5HexStr':_0x2e8d7f,'fileName':_0x581db7,'elementType':_0x335a3c,'elementSubType':_0x9bb05f,'thumbSize':0x0,'needCreate':!![],'downloadType':0x1,'file_uuid':''});await NTQQFileApi['copyFile'](_0x26eaf2,_0x5008e4);const _0x597946=await NTQQFileApi[_0x5246bf(0x119)](_0x26eaf2);return{'md5':_0x2e8d7f,'fileName':_0x581db7,'path':_0x5008e4,'fileSize':_0x597946,'ext':_0x366156};}static async['downloadMedia'](_0xa9865b,_0x4a8187,_0x272b17,_0x53193e,_0x3f8c0f,_0x1606bd,_0x380fe7=0x3e8*0x3c*0x2,_0x52ea6e=![]){const _0x32fbcc=_0x568a69,_0x5788fa={'DZkVM':function(_0x3c5303,_0x437078){return _0x3c5303===_0x437078;},'ZHAsT':function(_0x5dca57,_0x2cf256){return _0x5dca57(_0x2cf256);},'AwxZf':_0x32fbcc(0x12b),'qXxNw':function(_0x5e4158){return _0x5e4158();},'fuxMQ':function(_0x25191a,_0x240a79,_0x428c1a){return _0x25191a(_0x240a79,_0x428c1a);}};if(_0x1606bd&&_0x35d4c2[_0x32fbcc(0x111)](_0x1606bd)){if(_0x52ea6e)try{await _0x118895[_0x32fbcc(0x122)](_0x1606bd);}catch(_0x3022a0){}else return _0x1606bd;}return new Promise((_0x170073,_0x4f36b9)=>{const _0x1b0eda=_0x32fbcc;let _0x203a44=![];const _0x274e46=_0x42a175=>{const _0x4d2667=_0x3eb4;if(_0x5788fa[_0x4d2667(0x117)](_0x42a175['msgId'],_0xa9865b)){_0x203a44=!![];let _0x1928e5=_0x42a175[_0x4d2667(0xf0)];if(_0x1928e5[_0x4d2667(0xf4)]('\x5c')){const _0x427da6=sessionConfig[_0x4d2667(0x12a)];_0x1928e5=_0x790f6a[_0x4d2667(0x11a)](_0x427da6,_0x1928e5);}_0x5788fa[_0x4d2667(0xe9)](_0x170073,_0x1928e5);}};downloadMediaTasks[_0x1b0eda(0x109)](_0x5788fa['qXxNw'](randomUUID),_0x274e46),_0x5788fa[_0x1b0eda(0xec)](setTimeout,()=>{const _0x23f4f2=_0x1b0eda;!_0x203a44&&_0x5788fa[_0x23f4f2(0xe9)](_0x4f36b9,_0x5788fa['AwxZf']);},_0x380fe7),napCatCore['session'][_0x1b0eda(0x100)]()[_0x1b0eda(0xfa)]({'fileModelId':'0','downloadSourceType':0x0,'triggerType':0x1,'msgId':_0xa9865b,'chatType':_0x4a8187,'peerUid':_0x272b17,'elementId':_0x53193e,'thumbSize':0x0,'downloadType':0x1,'filePath':_0x3f8c0f});});}static async[_0x568a69(0xfc)](_0x560fa3){const _0x343fcd={'yeOMg':function(_0x3ef324,_0x485955,_0x216bdd){return _0x3ef324(_0x485955,_0x216bdd);}};return new Promise((_0x4e2a36,_0x4f45c5)=>{const _0x593ea0={'yRSDO':function(_0xfd4590,_0x539fce){return _0xfd4590(_0x539fce);}};_0x343fcd['yeOMg'](_0x2f74c5,_0x560fa3,(_0x3af628,_0x3861da)=>{const _0x36661a=_0x3eb4;_0x3af628?_0x593ea0[_0x36661a(0x112)](_0x4f45c5,_0x3af628):_0x593ea0['yRSDO'](_0x4e2a36,_0x3861da);});});}static async[_0x568a69(0xf1)](_0x1c6f3b,_0x588822){const _0x4a83d5=_0x568a69,_0x167351={'FDhXb':_0x4a83d5(0x10f),'jxgMR':_0x4a83d5(0x108),'fXgcu':function(_0x55be84,_0x5555d4){return _0x55be84+_0x5555d4;},'QrRZA':function(_0x6a302,_0x122edd){return _0x6a302+_0x122edd;},'guRvK':function(_0x37d3e3,_0x148591){return _0x37d3e3||_0x148591;},'QkJvn':function(_0x32421e,_0x42e076,_0x52e2a4){return _0x32421e(_0x42e076,_0x52e2a4);},'faoJI':_0x4a83d5(0x105)};if(!_0x1c6f3b)return'';const _0x5f522f=_0x1c6f3b[_0x4a83d5(0x124)],_0x5d0f22=_0x1c6f3b[_0x4a83d5(0x115)],_0xcdf636=_0x1c6f3b[_0x4a83d5(0x115)],_0x401877=_0x1c6f3b[_0x4a83d5(0x114)];if(_0x5f522f){if(_0x5f522f[_0x4a83d5(0xf4)](_0x167351[_0x4a83d5(0x102)])){if(_0x5f522f[_0x4a83d5(0x106)](_0x167351[_0x4a83d5(0xee)]))return IMAGE_HTTP_HOST_NT+_0x5f522f;const _0x598c52=await rkeyManager[_0x4a83d5(0xf9)](),_0x40dfe4=_0x588822?_0x598c52['private_rkey']:_0x598c52[_0x4a83d5(0x118)];return _0x167351[_0x4a83d5(0xff)](IMAGE_HTTP_HOST_NT,_0x5f522f)+(''+_0x40dfe4);}else return _0x167351[_0x4a83d5(0x107)](IMAGE_HTTP_HOST,_0x5f522f);}else{if(_0x167351[_0x4a83d5(0xf2)](_0xcdf636,_0x5d0f22))return IMAGE_HTTP_HOST+'/gchatpic_new/0/0-0-'+_0x167351[_0x4a83d5(0xf2)](_0xcdf636,_0x5d0f22)['toUpperCase']()+'/0';}return _0x167351[_0x4a83d5(0xf8)](logDebug,_0x167351['faoJI'],_0x1c6f3b),'';}}export class NTQQFileCacheApi{static async['setCacheSilentScan'](_0x4c312f=!![]){return'';}static[_0x568a69(0x116)](){return'';}static['clearCache'](_0x2cab46=['tmp','hotUpdate']){const _0x503c6d=_0x568a69;return napCatCore[_0x503c6d(0x10e)]['getStorageCleanService']()['clearCacheDataByKeys'](_0x2cab46);}static['addCacheScannedPaths'](_0x53914b={}){const _0x243261=_0x568a69;return napCatCore[_0x243261(0x10e)]['getStorageCleanService']()[_0x243261(0xe7)](_0x53914b);}static[_0x568a69(0x104)](){const _0x5cb6a2=_0x568a69;return napCatCore[_0x5cb6a2(0x10e)][_0x5cb6a2(0xe8)]()[_0x5cb6a2(0x104)]();}static[_0x568a69(0x113)](){return'';}static['getDesktopTmpPath'](){return'';}static[_0x568a69(0x10d)](_0x4f09e6,_0x36e631=0x3e8,_0x2ac597=0x0){const _0x34d2bb=_0x568a69;return napCatCore[_0x34d2bb(0x10e)]['getStorageCleanService']()[_0x34d2bb(0x11e)](_0x4f09e6,_0x36e631,0x1,_0x2ac597);}static['getFileCacheInfo'](_0x29f7bb,_0x2a983a=0x3e8,_0x58a6d8){const _0x16cb18=_0x58a6d8?_0x58a6d8:{'fileType':_0x29f7bb};}static async[_0x568a69(0x11b)](_0x38aeea=[],_0x92887d=[]){const _0x95c06=_0x568a69;return napCatCore[_0x95c06(0x10e)][_0x95c06(0xe8)]()[_0x95c06(0xe4)](_0x38aeea,_0x92887d);}}