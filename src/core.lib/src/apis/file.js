const _0x3bc9be=_0x1129;(function(_0x3510f3,_0x11dd46){const _0x5979b3=_0x1129,_0x58af27=_0x3510f3();while(!![]){try{const _0x475e3f=-parseInt(_0x5979b3(0xd9))/0x1+parseInt(_0x5979b3(0xaf))/0x2+-parseInt(_0x5979b3(0x98))/0x3*(-parseInt(_0x5979b3(0xb9))/0x4)+-parseInt(_0x5979b3(0xae))/0x5+parseInt(_0x5979b3(0xc1))/0x6+-parseInt(_0x5979b3(0xad))/0x7+parseInt(_0x5979b3(0xb4))/0x8;if(_0x475e3f===_0x11dd46)break;else _0x58af27['push'](_0x58af27['shift']());}catch(_0x4f257b){_0x58af27['push'](_0x58af27['shift']());}}}(_0x3a74,0xbff5f));import{ElementType,IMAGE_HTTP_HOST,IMAGE_HTTP_HOST_NT}from'@/core/entities';import _0x5f1cb0 from'path';import _0x33253c from'fs';import _0x955d75 from'fs/promises';import{logDebug}from'@/common/utils/log';import{napCatCore}from'@/core';import{calculateFileMD5}from'@/common/utils/file';import*as _0x38d303 from'file-type';import{MsgListener}from'@/core/listeners';import _0x45f970 from'image-size';function _0x1129(_0x19f01b,_0x117919){const _0x3a749e=_0x3a74();return _0x1129=function(_0x1129c0,_0x3222e8){_0x1129c0=_0x1129c0-0x8c;let _0x478948=_0x3a749e[_0x1129c0];return _0x478948;},_0x1129(_0x19f01b,_0x117919);}import{sessionConfig}from'@/core/sessionConfig';import{randomUUID}from'crypto';function _0x3a74(){const _0x542ec6=['url','pdiEl','unlink','filePath','koPTB','copyFile','SHgbm','getRkey','group_rkey','session','XnLTJ','图片url获取失败','getMsgService','clearCacheDataByKeys','fileUuid','md5HexStr','domainUrl','startsWith','includes','uploadFile','5393087lpwvQA','7008845OBSHxl','2296230rJTmXi','ext','basename','getChatCacheList','onRichMediaDownloadComplete','12763800wKqIzg','getFileCacheInfo','ClSJK','getCacheSessionPathList','zIhCr','179012CibeHF','scanCache','getImageUrl','urlResult','getHotUpdateCachePath','wlmlV','existsSync','msgId','8054172gcDsql','fileTypeFromFile','下载超时','hotUpdate','addCacheScannedPaths','umFvt','VURkq','YoSMb','getVideoUrl','peerUid','util','getFileSize','setCacheSilentScan','PIC','yCbmA','getVideoPlayUrlV2','getRichMediaFilePathForGuild','&rkey=','clearChatCache','toUpperCase','getStorageCleanService','onLoginSuccess','clearCache','uVANZ','1261730ZfQcfI','NyAdV','getDesktopTmpPath','FVIuq','getRichMediaService','getFileType','downloadRichMedia','chatType','addCacheScanedPaths','join','downloadMedia','originImageUrl','private_rkey','getImageSize','9oSYLOy'];_0x3a74=function(){return _0x542ec6;};return _0x3a74();}import{rkeyManager}from'../utils/rkey';import{AsyncQueue}from'@/common/utils/AsyncQueue';const getRKeyTaskQueue=new AsyncQueue(),downloadMediaTasks=new Map(),downloadMediaListener=new MsgListener();downloadMediaListener[_0x3bc9be(0xb3)]=_0x1dc05b=>{const _0x16ec2b=_0x3bc9be,_0x2f9374={'FVIuq':function(_0x2e826d,_0x3371a1){return _0x2e826d(_0x3371a1);}};for(const [_0x1018d2,_0x371fa7]of downloadMediaTasks){_0x2f9374[_0x16ec2b(0x8d)](_0x371fa7,_0x1dc05b),downloadMediaTasks['delete'](_0x1018d2);}},setTimeout(()=>{const _0x134fd2=_0x3bc9be;napCatCore[_0x134fd2(0xd6)](()=>{napCatCore['addListener'](downloadMediaListener);});},0x64);export class NTQQFileApi{static async['getFileType'](_0x54cab4){const _0x32b5b6=_0x3bc9be;return _0x38d303[_0x32b5b6(0xc2)](_0x54cab4);}static async['copyFile'](_0x31bc23,_0x3a827c){const _0x57923c=_0x3bc9be;await napCatCore['util'][_0x57923c(0x9e)](_0x31bc23,_0x3a827c);}static async[_0x3bc9be(0xcc)](_0x51ebc0){const _0x226a4a=_0x3bc9be;return await napCatCore[_0x226a4a(0xcb)][_0x226a4a(0xcc)](_0x51ebc0);}static async[_0x3bc9be(0xc9)](_0x1d3282,_0xe5c2a1){const _0x2245b7=_0x3bc9be;return(await napCatCore[_0x2245b7(0xa2)][_0x2245b7(0x8e)]()[_0x2245b7(0xd0)]({'chatType':_0x1d3282[_0x2245b7(0x91)],'peerUid':_0x1d3282[_0x2245b7(0xca)],'guildId':'0'},_0x1d3282[_0x2245b7(0xc0)],_0xe5c2a1['elementId'],0x0,{'downSourceType':0x1,'triggerType':0x1}))[_0x2245b7(0xbc)][_0x2245b7(0xa9)][0x0][_0x2245b7(0x99)];}static async[_0x3bc9be(0xac)](_0x2b64c2,_0x56676d=ElementType[_0x3bc9be(0xce)],_0x3c0c71=0x0){const _0x490ca4=_0x3bc9be,_0x53c9bb={'uVANZ':function(_0x2938af,_0x4d1ab5){return _0x2938af===_0x4d1ab5;}},_0x18fae5=await calculateFileMD5(_0x2b64c2);let _0x3ef404=(await NTQQFileApi[_0x490ca4(0x8f)](_0x2b64c2))?.[_0x490ca4(0xb0)]||'';_0x3ef404&&(_0x3ef404='.'+_0x3ef404);let _0x1077ab=''+_0x5f1cb0[_0x490ca4(0xb1)](_0x2b64c2);_0x53c9bb[_0x490ca4(0xd8)](_0x1077ab['indexOf']('.'),-0x1)&&(_0x1077ab+=_0x3ef404);const _0x568476=napCatCore[_0x490ca4(0xa2)]['getMsgService']()[_0x490ca4(0xd1)]({'md5HexStr':_0x18fae5,'fileName':_0x1077ab,'elementType':_0x56676d,'elementSubType':_0x3c0c71,'thumbSize':0x0,'needCreate':!![],'downloadType':0x1,'file_uuid':''});await NTQQFileApi[_0x490ca4(0x9e)](_0x2b64c2,_0x568476);const _0x493b3a=await NTQQFileApi[_0x490ca4(0xcc)](_0x2b64c2);return{'md5':_0x18fae5,'fileName':_0x1077ab,'path':_0x568476,'fileSize':_0x493b3a,'ext':_0x3ef404};}static async[_0x3bc9be(0x94)](_0x2a529a,_0x1b53cf,_0x3f11a6,_0x4d3881,_0x59df4f,_0x3a4686,_0x567e2b=0x3e8*0x3c*0x2,_0x432c0d=![]){const _0x52018a=_0x3bc9be,_0x18372a={'koPTB':function(_0x552015,_0xd25f7f){return _0x552015(_0xd25f7f);},'zIhCr':_0x52018a(0xc3),'yCbmA':function(_0x20b56e){return _0x20b56e();},'SHgbm':function(_0x53623f,_0x4b5843,_0x48cd6b){return _0x53623f(_0x4b5843,_0x48cd6b);}};if(_0x3a4686&&_0x33253c[_0x52018a(0xbf)](_0x3a4686)){if(_0x432c0d)try{await _0x955d75[_0x52018a(0x9b)](_0x3a4686);}catch(_0x442879){}else return _0x3a4686;}return new Promise((_0x3ff443,_0x2ed1f9)=>{const _0x5a6165=_0x52018a,_0x479dc9={'pdiEl':function(_0x28e69b,_0x48232a){return _0x28e69b(_0x48232a);},'inKiT':_0x18372a[_0x5a6165(0xb8)]};let _0x251f16=![];const _0x5e0bd8=_0x5c1708=>{const _0x37be87=_0x5a6165;if(_0x5c1708[_0x37be87(0xc0)]===_0x2a529a){_0x251f16=!![];let _0x126a69=_0x5c1708[_0x37be87(0x9c)];if(_0x126a69[_0x37be87(0xaa)]('\x5c')){const _0x5d40a7=sessionConfig['defaultFileDownloadPath'];_0x126a69=_0x5f1cb0[_0x37be87(0x93)](_0x5d40a7,_0x126a69);}_0x18372a[_0x37be87(0x9d)](_0x3ff443,_0x126a69);}};downloadMediaTasks['set'](_0x18372a[_0x5a6165(0xcf)](randomUUID),_0x5e0bd8),_0x18372a[_0x5a6165(0x9f)](setTimeout,()=>{const _0x2fb3a6=_0x5a6165;!_0x251f16&&_0x479dc9[_0x2fb3a6(0x9a)](_0x2ed1f9,_0x479dc9['inKiT']);},_0x567e2b),napCatCore[_0x5a6165(0xa2)][_0x5a6165(0xa5)]()[_0x5a6165(0x90)]({'fileModelId':'0','downloadSourceType':0x0,'triggerType':0x1,'msgId':_0x2a529a,'chatType':_0x1b53cf,'peerUid':_0x3f11a6,'elementId':_0x4d3881,'thumbSize':0x0,'downloadType':0x1,'filePath':_0x59df4f});});}static async[_0x3bc9be(0x97)](_0x17c5b0){const _0x3eb336={'JTBLL':function(_0x398b45,_0x4a83e9){return _0x398b45(_0x4a83e9);},'NyAdV':function(_0x140710,_0x3a05bf){return _0x140710(_0x3a05bf);}};return new Promise((_0x4e3458,_0x1dc655)=>{_0x45f970(_0x17c5b0,(_0x41e5c7,_0x1e088a)=>{const _0x45c98b=_0x1129;_0x41e5c7?_0x3eb336['JTBLL'](_0x1dc655,_0x41e5c7):_0x3eb336[_0x45c98b(0xda)](_0x4e3458,_0x1e088a);});});}static async[_0x3bc9be(0xbb)](_0x3bd09f,_0xaa92a8){const _0x4371df=_0x3bc9be,_0x28b678={'VURkq':'/download','XnLTJ':_0x4371df(0xd2),'wlmlV':function(_0x4f1ae4,_0x55e1ba){return _0x4f1ae4+_0x55e1ba;},'ClSJK':function(_0x39f68d,_0x5c1ad4){return _0x39f68d||_0x5c1ad4;},'YoSMb':function(_0x4c0098,_0x48765f,_0x4dbf68){return _0x4c0098(_0x48765f,_0x4dbf68);},'umFvt':_0x4371df(0xa4)};if(!_0x3bd09f)return'';const _0x551b3c=_0x3bd09f[_0x4371df(0x95)],_0xd8c641=_0x3bd09f[_0x4371df(0xa8)],_0x2e6c54=_0x3bd09f[_0x4371df(0xa8)],_0x2f881c=_0x3bd09f[_0x4371df(0xa7)];if(_0x551b3c){if(_0x551b3c[_0x4371df(0xaa)](_0x28b678[_0x4371df(0xc7)])){if(_0x551b3c[_0x4371df(0xab)](_0x28b678[_0x4371df(0xa3)]))return IMAGE_HTTP_HOST_NT+_0x551b3c;const _0x3fdff5=await rkeyManager[_0x4371df(0xa0)](),_0x337af0=_0xaa92a8?_0x3fdff5[_0x4371df(0x96)]:_0x3fdff5[_0x4371df(0xa1)];return _0x28b678[_0x4371df(0xbe)](IMAGE_HTTP_HOST_NT+_0x551b3c,''+_0x337af0);}else return _0x28b678[_0x4371df(0xbe)](IMAGE_HTTP_HOST,_0x551b3c);}else{if(_0x28b678['ClSJK'](_0x2e6c54,_0xd8c641))return IMAGE_HTTP_HOST+'/gchatpic_new/0/0-0-'+_0x28b678[_0x4371df(0xb6)](_0x2e6c54,_0xd8c641)[_0x4371df(0xd4)]()+'/0';}return _0x28b678[_0x4371df(0xc8)](logDebug,_0x28b678[_0x4371df(0xc6)],_0x3bd09f),'';}}export class NTQQFileCacheApi{static async[_0x3bc9be(0xcd)](_0x2c2f77=!![]){return'';}static[_0x3bc9be(0xb7)](){return'';}static[_0x3bc9be(0xd7)](_0x162a97=['tmp',_0x3bc9be(0xc4)]){const _0x301637=_0x3bc9be;return napCatCore[_0x301637(0xa2)][_0x301637(0xd5)]()[_0x301637(0xa6)](_0x162a97);}static[_0x3bc9be(0xc5)](_0x45450a={}){const _0x5afd3a=_0x3bc9be;return napCatCore['session']['getStorageCleanService']()[_0x5afd3a(0x92)](_0x45450a);}static[_0x3bc9be(0xba)](){const _0x40efa7=_0x3bc9be;return napCatCore[_0x40efa7(0xa2)][_0x40efa7(0xd5)]()[_0x40efa7(0xba)]();}static[_0x3bc9be(0xbd)](){return'';}static[_0x3bc9be(0x8c)](){return'';}static[_0x3bc9be(0xb2)](_0x4ab1a5,_0x3f31e5=0x3e8,_0x23f6de=0x0){const _0x3b3aa1=_0x3bc9be;return napCatCore[_0x3b3aa1(0xa2)][_0x3b3aa1(0xd5)]()['getChatCacheInfo'](_0x4ab1a5,_0x3f31e5,0x1,_0x23f6de);}static[_0x3bc9be(0xb5)](_0x4a0684,_0x4d6ead=0x3e8,_0xb990b2){const _0x441af5=_0xb990b2?_0xb990b2:{'fileType':_0x4a0684};}static async[_0x3bc9be(0xd3)](_0x327240=[],_0x48df0d=[]){const _0x83999b=_0x3bc9be;return napCatCore[_0x83999b(0xa2)][_0x83999b(0xd5)]()['clearChatCacheInfo'](_0x327240,_0x48df0d);}}