const _0x275977=_0xf4b8;(function(_0x1f1399,_0x47bc77){const _0x5b1621=_0xf4b8,_0x5596e7=_0x1f1399();while(!![]){try{const _0x29ace8=-parseInt(_0x5b1621(0x1e6))/0x1+parseInt(_0x5b1621(0x20d))/0x2+parseInt(_0x5b1621(0x1cc))/0x3*(parseInt(_0x5b1621(0x1f0))/0x4)+parseInt(_0x5b1621(0x1eb))/0x5+parseInt(_0x5b1621(0x208))/0x6*(parseInt(_0x5b1621(0x1e4))/0x7)+parseInt(_0x5b1621(0x1e8))/0x8+parseInt(_0x5b1621(0x207))/0x9*(-parseInt(_0x5b1621(0x203))/0xa);if(_0x29ace8===_0x47bc77)break;else _0x5596e7['push'](_0x5596e7['shift']());}catch(_0x2b5f00){_0x5596e7['push'](_0x5596e7['shift']());}}}(_0x4e73,0x3e396));import{ElementType,IMAGE_HTTP_HOST,IMAGE_HTTP_HOST_NT}from'@/core/entities';import _0x240d15 from'path';import _0x32c168 from'fs';function _0xf4b8(_0x2c3696,_0x3e90f5){const _0x4e735d=_0x4e73();return _0xf4b8=function(_0xf4b8ae,_0x1565ad){_0xf4b8ae=_0xf4b8ae-0x1c1;let _0x168e54=_0x4e735d[_0xf4b8ae];return _0x168e54;},_0xf4b8(_0x2c3696,_0x3e90f5);}function _0x4e73(){const _0x65f56b=['getFileType','downloadMedia','WixLp','defaultFileDownloadPath','md5HexStr','getStorageCleanService','chatType','ocpBT','getChatCacheList','getVideoPlayUrlV2','getFileCacheInfo','copyFile','hotUpdate','3250QEpDSf','getVideoUrl','msgId','existsSync','20781dxwZeA','20316eZOrMW','ext','clearChatCache','nQzXD','getChatCacheInfo','727490bjfoHC','abDgu','getHotUpdateCachePath','图片url获取失败','QMdIk','QqvVB','addListener','addCacheScannedPaths','startsWith','tmp','getImageUrl','onRichMediaDownloadComplete','clearCacheDataByKeys','addCacheScanedPaths','getImageSize','esZIG','46737vHvQje','originImageUrl','set','PIC','delete','downloadRichMedia','group_rkey','FqKjU','getRkey','fileTypeFromFile','/gchatpic_new/0/0-0-','toUpperCase','getDesktopTmpPath','XYaWB','clearChatCacheInfo','basename','Faycm','clearCache','session','elementId','domainUrl','util','WvEAa','url','770KPlkVj','bSJzR','474355yrSdMm','/download','1699544yquFEX','下载超时','getFileSize','1175005TCKiAj','scanCache','getMsgService','EbjJi','mocWI','76ielgAa','filePath','XUcrd','rfCEu','getRichMediaService','urlResult'];_0x4e73=function(){return _0x65f56b;};return _0x4e73();}import _0x39d747 from'fs/promises';import{logDebug}from'@/common/utils/log';import{napCatCore}from'@/core';import{calculateFileMD5}from'@/common/utils/file';import*as _0x29c9d1 from'file-type';import{MsgListener}from'@/core/listeners';import _0x5e67cd from'image-size';import{sessionConfig}from'@/core/sessionConfig';import{randomUUID}from'crypto';import{rkeyManager}from'../utils/rkey';import{AsyncQueue}from'@/common/utils/AsyncQueue';const getRKeyTaskQueue=new AsyncQueue(),downloadMediaTasks=new Map(),downloadMediaListener=new MsgListener();downloadMediaListener[_0x275977(0x1c7)]=_0x594c2c=>{const _0x4b7a64=_0x275977,_0x989568={'EbjJi':function(_0x19b3a0,_0x4b7717){return _0x19b3a0(_0x4b7717);}};for(const [_0x3234da,_0x50dac5]of downloadMediaTasks){_0x989568[_0x4b7a64(0x1ee)](_0x50dac5,_0x594c2c),downloadMediaTasks[_0x4b7a64(0x1d0)](_0x3234da);}},setTimeout(()=>{napCatCore['onLoginSuccess'](()=>{const _0x18ed0a=_0xf4b8;napCatCore[_0x18ed0a(0x1c2)](downloadMediaListener);});},0x64);export class NTQQFileApi{static async[_0x275977(0x1f6)](_0x16995a){const _0x23fbb4=_0x275977;return _0x29c9d1[_0x23fbb4(0x1d5)](_0x16995a);}static async[_0x275977(0x201)](_0x9c0c79,_0x552563){const _0x44cdac=_0x275977;await napCatCore['util'][_0x44cdac(0x201)](_0x9c0c79,_0x552563);}static async[_0x275977(0x1ea)](_0xefe639){const _0x1d6d1e=_0x275977;return await napCatCore[_0x1d6d1e(0x1e1)]['getFileSize'](_0xefe639);}static async[_0x275977(0x204)](_0x2abe39,_0x50f80b){const _0xfa65e2=_0x275977;return(await napCatCore['session'][_0xfa65e2(0x1f4)]()[_0xfa65e2(0x1ff)]({'chatType':_0x2abe39[_0xfa65e2(0x1fc)],'peerUid':_0x2abe39['peerUid'],'guildId':'0'},_0x2abe39[_0xfa65e2(0x205)],_0x50f80b[_0xfa65e2(0x1df)],0x0,{'downSourceType':0x1,'triggerType':0x1}))[_0xfa65e2(0x1f5)][_0xfa65e2(0x1e0)][0x0][_0xfa65e2(0x1e3)];}static async['uploadFile'](_0x39affa,_0x1d5a2f=ElementType[_0x275977(0x1cf)],_0x56a97f=0x0){const _0x12af80=_0x275977,_0x4b2afb={'ZkjRz':function(_0x2ea274,_0x520e92){return _0x2ea274(_0x520e92);},'rfCEu':function(_0x359afb,_0x40a3d8){return _0x359afb+_0x40a3d8;},'nQzXD':function(_0x2c125d,_0x23d6bc){return _0x2c125d===_0x23d6bc;}},_0x4a2e46=await _0x4b2afb['ZkjRz'](calculateFileMD5,_0x39affa);let _0x1aea7b=(await NTQQFileApi['getFileType'](_0x39affa))?.[_0x12af80(0x209)]||'';_0x1aea7b&&(_0x1aea7b=_0x4b2afb[_0x12af80(0x1f3)]('.',_0x1aea7b));let _0x4108e9=''+_0x240d15[_0x12af80(0x1db)](_0x39affa);_0x4b2afb[_0x12af80(0x20b)](_0x4108e9['indexOf']('.'),-0x1)&&(_0x4108e9+=_0x1aea7b);const _0x19e854=napCatCore[_0x12af80(0x1de)][_0x12af80(0x1ed)]()['getRichMediaFilePathForGuild']({'md5HexStr':_0x4a2e46,'fileName':_0x4108e9,'elementType':_0x1d5a2f,'elementSubType':_0x56a97f,'thumbSize':0x0,'needCreate':!![],'downloadType':0x1,'file_uuid':''});await NTQQFileApi[_0x12af80(0x201)](_0x39affa,_0x19e854);const _0x1c3f17=await NTQQFileApi[_0x12af80(0x1ea)](_0x39affa);return{'md5':_0x4a2e46,'fileName':_0x4108e9,'path':_0x19e854,'fileSize':_0x1c3f17,'ext':_0x1aea7b};}static async[_0x275977(0x1f7)](_0x52cf8a,_0x3a2f7b,_0x2ea46a,_0x470415,_0x388c08,_0x790cb4,_0x5771bd=0x3e8*0x3c*0x2,_0x506c13=![]){const _0x484038=_0x275977,_0x4d48a9={'ocpBT':function(_0x4d0c95,_0x5233d0){return _0x4d0c95(_0x5233d0);},'esZIG':function(_0x4e325e,_0x61594){return _0x4e325e(_0x61594);},'abDgu':_0x484038(0x1e9),'XYaWB':function(_0x4ebeb5){return _0x4ebeb5();},'mocWI':function(_0x4b9290,_0x223d32,_0x4d86ed){return _0x4b9290(_0x223d32,_0x4d86ed);}};if(_0x790cb4&&_0x32c168[_0x484038(0x206)](_0x790cb4)){if(_0x506c13)try{await _0x39d747['unlink'](_0x790cb4);}catch(_0x123ae6){}else return _0x790cb4;}return new Promise((_0x45cfef,_0x12eff8)=>{const _0xd3fe8d=_0x484038;let _0x5cd314=![];const _0x26bde2=_0x5ee9e3=>{const _0x57a22f=_0xf4b8;if(_0x5ee9e3[_0x57a22f(0x205)]===_0x52cf8a){_0x5cd314=!![];let _0x1ad769=_0x5ee9e3[_0x57a22f(0x1f1)];if(_0x1ad769[_0x57a22f(0x1c4)]('\x5c')){const _0x5b9fa4=sessionConfig[_0x57a22f(0x1f9)];_0x1ad769=_0x240d15['join'](_0x5b9fa4,_0x1ad769);}_0x4d48a9[_0x57a22f(0x1fd)](_0x45cfef,_0x1ad769);}};downloadMediaTasks[_0xd3fe8d(0x1ce)](_0x4d48a9[_0xd3fe8d(0x1d9)](randomUUID),_0x26bde2),_0x4d48a9[_0xd3fe8d(0x1ef)](setTimeout,()=>{const _0x230ed2=_0xd3fe8d;!_0x5cd314&&_0x4d48a9[_0x230ed2(0x1cb)](_0x12eff8,_0x4d48a9[_0x230ed2(0x20e)]);},_0x5771bd),napCatCore['session'][_0xd3fe8d(0x1ed)]()[_0xd3fe8d(0x1d1)]({'fileModelId':'0','downloadSourceType':0x0,'triggerType':0x1,'msgId':_0x52cf8a,'chatType':_0x3a2f7b,'peerUid':_0x2ea46a,'elementId':_0x470415,'thumbSize':0x0,'downloadType':0x1,'filePath':_0x388c08});});}static async[_0x275977(0x1ca)](_0x5a09c5){const _0x30035c={'FqKjU':function(_0x1633df,_0x5dfbe4){return _0x1633df(_0x5dfbe4);},'XUcrd':function(_0x25fef1,_0x5f3632){return _0x25fef1(_0x5f3632);},'WvEAa':function(_0x7c7d9c,_0x17367c,_0x20a602){return _0x7c7d9c(_0x17367c,_0x20a602);}};return new Promise((_0x53c343,_0x5491b4)=>{const _0x2efc08=_0xf4b8;_0x30035c[_0x2efc08(0x1e2)](_0x5e67cd,_0x5a09c5,(_0x5f326a,_0x286d51)=>{const _0x198f70=_0x2efc08;_0x5f326a?_0x30035c[_0x198f70(0x1d3)](_0x5491b4,_0x5f326a):_0x30035c[_0x198f70(0x1f2)](_0x53c343,_0x286d51);});});}static async[_0x275977(0x1c6)](_0x210b5a,_0x49b3d8){const _0x4bc2e9=_0x275977,_0x24c73e={'QqvVB':'&rkey=','QMdIk':function(_0x489132,_0x444de0){return _0x489132+_0x444de0;},'Faycm':function(_0x2e5e0e,_0x12ea71){return _0x2e5e0e||_0x12ea71;},'bSJzR':function(_0x5ce38e,_0x56d9c5,_0x518a15){return _0x5ce38e(_0x56d9c5,_0x518a15);},'WixLp':_0x4bc2e9(0x210)};if(!_0x210b5a)return'';const _0x131efd=_0x210b5a[_0x4bc2e9(0x1cd)],_0x51b105=_0x210b5a[_0x4bc2e9(0x1fa)],_0x1fc10d=_0x210b5a[_0x4bc2e9(0x1fa)],_0x5a4f6a=_0x210b5a['fileUuid'];if(_0x131efd){if(_0x131efd['startsWith'](_0x4bc2e9(0x1e7))){if(_0x131efd['includes'](_0x24c73e[_0x4bc2e9(0x1c1)]))return _0x24c73e[_0x4bc2e9(0x211)](IMAGE_HTTP_HOST_NT,_0x131efd);const _0x1471fd=await rkeyManager[_0x4bc2e9(0x1d4)](),_0x5cce2f=_0x49b3d8?_0x1471fd['private_rkey']:_0x1471fd[_0x4bc2e9(0x1d2)];return _0x24c73e[_0x4bc2e9(0x211)](IMAGE_HTTP_HOST_NT,_0x131efd)+(''+_0x5cce2f);}else return IMAGE_HTTP_HOST+_0x131efd;}else{if(_0x24c73e[_0x4bc2e9(0x1dc)](_0x1fc10d,_0x51b105))return IMAGE_HTTP_HOST+_0x4bc2e9(0x1d6)+_0x24c73e['Faycm'](_0x1fc10d,_0x51b105)[_0x4bc2e9(0x1d7)]()+'/0';}return _0x24c73e[_0x4bc2e9(0x1e5)](logDebug,_0x24c73e[_0x4bc2e9(0x1f8)],_0x210b5a),'';}}export class NTQQFileCacheApi{static async['setCacheSilentScan'](_0x476fd3=!![]){return'';}static['getCacheSessionPathList'](){return'';}static[_0x275977(0x1dd)](_0x1eb336=[_0x275977(0x1c5),_0x275977(0x202)]){const _0x2330ab=_0x275977;return napCatCore[_0x2330ab(0x1de)][_0x2330ab(0x1fb)]()[_0x2330ab(0x1c8)](_0x1eb336);}static[_0x275977(0x1c3)](_0x283f77={}){const _0x156bef=_0x275977;return napCatCore[_0x156bef(0x1de)][_0x156bef(0x1fb)]()[_0x156bef(0x1c9)](_0x283f77);}static['scanCache'](){const _0x4c442f=_0x275977;return napCatCore['session']['getStorageCleanService']()[_0x4c442f(0x1ec)]();}static[_0x275977(0x20f)](){return'';}static[_0x275977(0x1d8)](){return'';}static[_0x275977(0x1fe)](_0x3e7284,_0x65c506=0x3e8,_0x4bdac1=0x0){const _0x24a02d=_0x275977;return napCatCore[_0x24a02d(0x1de)][_0x24a02d(0x1fb)]()[_0x24a02d(0x20c)](_0x3e7284,_0x65c506,0x1,_0x4bdac1);}static[_0x275977(0x200)](_0x3cd7a5,_0xb118e4=0x3e8,_0x3b7a96){const _0x352177=_0x3b7a96?_0x3b7a96:{'fileType':_0x3cd7a5};}static async[_0x275977(0x20a)](_0x1041f9=[],_0x47db3a=[]){const _0x486796=_0x275977;return napCatCore['session']['getStorageCleanService']()[_0x486796(0x1da)](_0x1041f9,_0x47db3a);}}