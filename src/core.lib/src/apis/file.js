const _0x27e3de=_0x2b3e;(function(_0x294a54,_0x41390b){const _0x5a390e=_0x2b3e,_0x3eb7ba=_0x294a54();while(!![]){try{const _0x7c1bde=parseInt(_0x5a390e(0x1a5))/0x1*(-parseInt(_0x5a390e(0x19a))/0x2)+-parseInt(_0x5a390e(0x188))/0x3*(parseInt(_0x5a390e(0x189))/0x4)+parseInt(_0x5a390e(0x19f))/0x5*(parseInt(_0x5a390e(0x171))/0x6)+-parseInt(_0x5a390e(0x1a2))/0x7+-parseInt(_0x5a390e(0x170))/0x8*(parseInt(_0x5a390e(0x1b1))/0x9)+parseInt(_0x5a390e(0x166))/0xa+parseInt(_0x5a390e(0x168))/0xb;if(_0x7c1bde===_0x41390b)break;else _0x3eb7ba['push'](_0x3eb7ba['shift']());}catch(_0x55ef54){_0x3eb7ba['push'](_0x3eb7ba['shift']());}}}(_0x57d4,0x72339));import{ElementType,IMAGE_HTTP_HOST,IMAGE_HTTP_HOST_NT}from'@/core/entities';function _0x57d4(){const _0x25720b=['setCacheSilentScan','chatType','ADniO','602001OtbBZa','rvzBC','addCacheScanedPaths','copyFile','/download','uploadFile','getStorageCleanService','8317690uqeOrP','unlink','15446739kMaJjY','originImageUrl','onRichMediaDownloadComplete','indexOf','getFileCacheInfo','scanCache','fileUuid','getMsgService','104KViOGE','6QIustI','url','join','downloadRichMedia','mzmUM','downloadMedia','clearCache','upOmP','clearChatCacheInfo','set','nRCpR','delete','filePath','hotUpdate','getImageUrl','MigSk','jpuZD','图片url获取失败','CPddY','msgId','eXpAc','getRichMediaService','sLJfo','61032kpUQOm','124VVVdZu','&rkey=','includes','getVideoUrl','clearCacheDataByKeys','domainUrl','getHotUpdateCachePath','existsSync','getVideoPlayUrlV2','startsWith','elementId','doHPt','下载超时','WrzgM','session','dllrQ','getFileSize','20438BBaRyH','addListener','getDesktopTmpPath','lUCrU','peerUid','2038205gEfUcr','onLoginSuccess','oTqbx','151571WvLcYM','clearChatCache','getFileType','64vItEgI','md5HexStr','private_rkey','addCacheScannedPaths','aXbDq','jOSXT','toUpperCase','defaultFileDownloadPath','util'];_0x57d4=function(){return _0x25720b;};return _0x57d4();}import _0x21da7f from'path';import _0x54f137 from'fs';import _0x3163f5 from'fs/promises';import{logDebug}from'@/common/utils/log';import{napCatCore}from'@/core';import{calculateFileMD5}from'@/common/utils/file';import*as _0x5c0d3f from'file-type';import{MsgListener}from'@/core/listeners';import _0x3279cc from'image-size';import{sessionConfig}from'@/core/sessionConfig';import{randomUUID}from'crypto';function _0x2b3e(_0x1c2a9e,_0x10cbe4){const _0x57d45f=_0x57d4();return _0x2b3e=function(_0x2b3ea1,_0x3395db){_0x2b3ea1=_0x2b3ea1-0x164;let _0x2b040b=_0x57d45f[_0x2b3ea1];return _0x2b040b;},_0x2b3e(_0x1c2a9e,_0x10cbe4);}import{rkeyManager}from'../utils/rkey';import{AsyncQueue}from'@/common/utils/AsyncQueue';const getRKeyTaskQueue=new AsyncQueue(),downloadMediaTasks=new Map(),downloadMediaListener=new MsgListener();downloadMediaListener[_0x27e3de(0x16a)]=_0x2ff70f=>{const _0x4de10d=_0x27e3de,_0x152f2e={'oTqbx':function(_0xc80bc9,_0x2d8506){return _0xc80bc9(_0x2d8506);}};for(const [_0xb9f7de,_0x695165]of downloadMediaTasks){_0x152f2e[_0x4de10d(0x1a1)](_0x695165,_0x2ff70f),downloadMediaTasks[_0x4de10d(0x17c)](_0xb9f7de);}},setTimeout(()=>{const _0xd7f760=_0x27e3de;napCatCore[_0xd7f760(0x1a0)](()=>{const _0x3c2ecb=_0xd7f760;napCatCore[_0x3c2ecb(0x19b)](downloadMediaListener);});},0x64);export class NTQQFileApi{static async['getFileType'](_0x10e9de){return _0x5c0d3f['fileTypeFromFile'](_0x10e9de);}static async['copyFile'](_0x34bd81,_0xf56d12){const _0x35ee1b=_0x27e3de;await napCatCore[_0x35ee1b(0x1ad)][_0x35ee1b(0x1b4)](_0x34bd81,_0xf56d12);}static async[_0x27e3de(0x199)](_0x511cdd){const _0x3f271e=_0x27e3de;return await napCatCore[_0x3f271e(0x1ad)]['getFileSize'](_0x511cdd);}static async[_0x27e3de(0x18c)](_0x5078d0,_0x5b5af5){const _0x3adbd7=_0x27e3de;return(await napCatCore[_0x3adbd7(0x197)][_0x3adbd7(0x186)]()[_0x3adbd7(0x191)]({'chatType':_0x5078d0[_0x3adbd7(0x1af)],'peerUid':_0x5078d0[_0x3adbd7(0x19e)],'guildId':'0'},_0x5078d0['msgId'],_0x5b5af5[_0x3adbd7(0x193)],0x0,{'downSourceType':0x1,'triggerType':0x1}))['urlResult'][_0x3adbd7(0x18e)][0x0][_0x3adbd7(0x172)];}static async[_0x27e3de(0x164)](_0x5ba9af,_0x35aff4=ElementType['PIC'],_0x3e6655=0x0){const _0x44d97c=_0x27e3de,_0x34e499={'lUCrU':function(_0x1c71ee,_0x5bfb8e){return _0x1c71ee(_0x5bfb8e);},'CPddY':function(_0x261a77,_0x49c492){return _0x261a77===_0x49c492;}},_0x2db6b8=await _0x34e499[_0x44d97c(0x19d)](calculateFileMD5,_0x5ba9af);let _0x3d30f9=(await NTQQFileApi[_0x44d97c(0x1a4)](_0x5ba9af))?.['ext']||'';_0x3d30f9&&(_0x3d30f9='.'+_0x3d30f9);let _0x1c85da=''+_0x21da7f['basename'](_0x5ba9af);_0x34e499[_0x44d97c(0x183)](_0x1c85da[_0x44d97c(0x16b)]('.'),-0x1)&&(_0x1c85da+=_0x3d30f9);const _0x406b7b=napCatCore[_0x44d97c(0x197)][_0x44d97c(0x16f)]()['getRichMediaFilePathForGuild']({'md5HexStr':_0x2db6b8,'fileName':_0x1c85da,'elementType':_0x35aff4,'elementSubType':_0x3e6655,'thumbSize':0x0,'needCreate':!![],'downloadType':0x1,'file_uuid':''});await NTQQFileApi[_0x44d97c(0x1b4)](_0x5ba9af,_0x406b7b);const _0x400efe=await NTQQFileApi['getFileSize'](_0x5ba9af);return{'md5':_0x2db6b8,'fileName':_0x1c85da,'path':_0x406b7b,'fileSize':_0x400efe,'ext':_0x3d30f9};}static async[_0x27e3de(0x176)](_0x4e3bad,_0x5d1265,_0x458193,_0x682d4a,_0x10e295,_0x30ae88,_0x4ac35b=0x3e8*0x3c*0x2,_0x5f4946=![]){const _0x4dfab0=_0x27e3de,_0x579f55={'CWNxj':function(_0x5c14cc,_0x5ac7d8){return _0x5c14cc(_0x5ac7d8);},'WrzgM':_0x4dfab0(0x195),'nRCpR':function(_0x4efebb,_0x4d54d3){return _0x4efebb===_0x4d54d3;},'sLJfo':function(_0x14428a){return _0x14428a();}};if(_0x30ae88&&_0x54f137[_0x4dfab0(0x190)](_0x30ae88)){if(_0x5f4946)try{await _0x3163f5[_0x4dfab0(0x167)](_0x30ae88);}catch(_0x403820){}else return _0x30ae88;}return new Promise((_0x3b6de3,_0x36682a)=>{const _0x2ebf0f=_0x4dfab0,_0x569190={'MigSk':function(_0x479edc,_0x3a86ba){const _0xe27eee=_0x2b3e;return _0x579f55[_0xe27eee(0x17b)](_0x479edc,_0x3a86ba);},'doHPt':function(_0x1bb72d,_0x387e2a){return _0x1bb72d(_0x387e2a);}};let _0x1f9744=![];const _0x37d790=_0x2870b6=>{const _0x1d8ea5=_0x2b3e;if(_0x569190[_0x1d8ea5(0x180)](_0x2870b6[_0x1d8ea5(0x184)],_0x4e3bad)){_0x1f9744=!![];let _0x215a05=_0x2870b6[_0x1d8ea5(0x17d)];if(_0x215a05[_0x1d8ea5(0x192)]('\x5c')){const _0xd2712=sessionConfig[_0x1d8ea5(0x1ac)];_0x215a05=_0x21da7f[_0x1d8ea5(0x173)](_0xd2712,_0x215a05);}_0x569190[_0x1d8ea5(0x194)](_0x3b6de3,_0x215a05);}};downloadMediaTasks[_0x2ebf0f(0x17a)](_0x579f55[_0x2ebf0f(0x187)](randomUUID),_0x37d790),setTimeout(()=>{const _0x38f3f7=_0x2ebf0f;!_0x1f9744&&_0x579f55['CWNxj'](_0x36682a,_0x579f55[_0x38f3f7(0x196)]);},_0x4ac35b),napCatCore[_0x2ebf0f(0x197)]['getMsgService']()[_0x2ebf0f(0x174)]({'fileModelId':'0','downloadSourceType':0x0,'triggerType':0x1,'msgId':_0x4e3bad,'chatType':_0x5d1265,'peerUid':_0x458193,'elementId':_0x682d4a,'thumbSize':0x0,'downloadType':0x1,'filePath':_0x10e295});});}static async['getImageSize'](_0x411ed3){const _0x5eabe1={'ADniO':function(_0x4a3181,_0x586ddb){return _0x4a3181(_0x586ddb);}};return new Promise((_0x352760,_0x1cefa6)=>{const _0x5dc762={'mzmUM':function(_0x1d7139,_0x9f7ae4){const _0x5b6355=_0x2b3e;return _0x5eabe1[_0x5b6355(0x1b0)](_0x1d7139,_0x9f7ae4);}};_0x3279cc(_0x411ed3,(_0x9112b0,_0x5b21af)=>{const _0x49841e=_0x2b3e;_0x9112b0?_0x1cefa6(_0x9112b0):_0x5dc762[_0x49841e(0x175)](_0x352760,_0x5b21af);});});}static async[_0x27e3de(0x17f)](_0x3df120,_0x350881){const _0x5cea18=_0x27e3de,_0x27de60={'jOSXT':_0x5cea18(0x1b5),'aXbDq':_0x5cea18(0x18a),'dllrQ':function(_0xc02600,_0x97d82a){return _0xc02600+_0x97d82a;},'rvzBC':function(_0x2ac3ec,_0x57065e){return _0x2ac3ec+_0x57065e;},'jpuZD':function(_0x22cd8b,_0x49cbba){return _0x22cd8b+_0x49cbba;},'upOmP':function(_0x385a35,_0x50ea7c,_0x542233){return _0x385a35(_0x50ea7c,_0x542233);},'eXpAc':_0x5cea18(0x182)};if(!_0x3df120)return'';const _0x16c8f3=_0x3df120[_0x5cea18(0x169)],_0x143d4c=_0x3df120['md5HexStr'],_0x57522e=_0x3df120[_0x5cea18(0x1a6)],_0x59978e=_0x3df120[_0x5cea18(0x16e)];if(_0x16c8f3){if(_0x16c8f3[_0x5cea18(0x192)](_0x27de60[_0x5cea18(0x1aa)])){if(_0x16c8f3[_0x5cea18(0x18b)](_0x27de60[_0x5cea18(0x1a9)]))return _0x27de60[_0x5cea18(0x198)](IMAGE_HTTP_HOST_NT,_0x16c8f3);const _0x1555d7=await rkeyManager['getRkey'](),_0x3c242c=_0x350881?_0x1555d7[_0x5cea18(0x1a7)]:_0x1555d7['group_rkey'];return _0x27de60[_0x5cea18(0x1b2)](_0x27de60[_0x5cea18(0x181)](IMAGE_HTTP_HOST_NT,_0x16c8f3),''+_0x3c242c);}else return _0x27de60[_0x5cea18(0x181)](IMAGE_HTTP_HOST,_0x16c8f3);}else{if(_0x57522e||_0x143d4c)return IMAGE_HTTP_HOST+'/gchatpic_new/0/0-0-'+(_0x57522e||_0x143d4c)[_0x5cea18(0x1ab)]()+'/0';}return _0x27de60[_0x5cea18(0x178)](logDebug,_0x27de60[_0x5cea18(0x185)],_0x3df120),'';}}export class NTQQFileCacheApi{static async[_0x27e3de(0x1ae)](_0x498e92=!![]){return'';}static['getCacheSessionPathList'](){return'';}static[_0x27e3de(0x177)](_0x4446dd=['tmp',_0x27e3de(0x17e)]){const _0x29f470=_0x27e3de;return napCatCore[_0x29f470(0x197)][_0x29f470(0x165)]()[_0x29f470(0x18d)](_0x4446dd);}static[_0x27e3de(0x1a8)](_0x4d5a6b={}){const _0x3d928b=_0x27e3de;return napCatCore[_0x3d928b(0x197)][_0x3d928b(0x165)]()[_0x3d928b(0x1b3)](_0x4d5a6b);}static[_0x27e3de(0x16d)](){const _0x39a2ad=_0x27e3de;return napCatCore['session'][_0x39a2ad(0x165)]()[_0x39a2ad(0x16d)]();}static[_0x27e3de(0x18f)](){return'';}static[_0x27e3de(0x19c)](){return'';}static['getChatCacheList'](_0x2f82a3,_0x20e853=0x3e8,_0x4dbb4d=0x0){const _0x37eb94=_0x27e3de;return napCatCore['session'][_0x37eb94(0x165)]()['getChatCacheInfo'](_0x2f82a3,_0x20e853,0x1,_0x4dbb4d);}static[_0x27e3de(0x16c)](_0x418c87,_0x50e925=0x3e8,_0x48427e){const _0x7c7a21=_0x48427e?_0x48427e:{'fileType':_0x418c87};}static async[_0x27e3de(0x1a3)](_0x5eb73c=[],_0x1fb48a=[]){const _0x397874=_0x27e3de;return napCatCore['session'][_0x397874(0x165)]()[_0x397874(0x179)](_0x5eb73c,_0x1fb48a);}}