const _0x92b842=_0x3091;function _0x1e78(){const _0x4cfbf5=['AniStickerType','16fGMUXa','3544233xZaZwF','https://tianquan.gtimg.cn/shoal/qqAIAgent/3e9d70c9-d98c-45b8-80b4-79d82971b514.png','miniapp','PTT','2yYcpii','PiBJz','LolCQ','toString','_0.png','1045830kKbLrS','TEXT','201997rUvqTn','3EOoaqP','AniStickerId','JKHEO','hrPOO','stat','LXZVR','gogvo','catch','grZix','35128tPCvuV','pic','VIDEO','get','slZal','Afekb','unlink','ARK','REPLY','GEkXn','aNEAK','FILE','QSid','screenshots','Thumb','file','wEmvl','auCxw','文件异常，大小为0','Xqtwl','FACE','RPS','MARKDOWN','QDes','stringify','find','copyFile','text','[骰子]','cTvEL','reply','https://tianquan.gtimg.cn/qqAIAgent/item/7/square.png','dice','dirname','1178807bCmDhI','获取视频信息失败','uploadFile','95yOyWth','AniStickerPackId','then','end','AKltk','JhiBw','MFACE','1057419mzhwXO','mface','xRMgf','markdown','getImageSize','VWwrH','height','Ori','QMcPN','error','rIlcR','width','rps','sysface','获取视频封面失败，使用默认封面','31422MTRJXV','PIC','set','sep','olDrN','ark','[商城表情]'];_0x1e78=function(){return _0x4cfbf5;};return _0x1e78();}function _0x3091(_0x409931,_0x51b3f9){const _0x1e7830=_0x1e78();return _0x3091=function(_0x3091a7,_0x389002){_0x3091a7=_0x3091a7-0x180;let _0x510e5b=_0x1e7830[_0x3091a7];return _0x510e5b;},_0x3091(_0x409931,_0x51b3f9);}(function(_0x314c43,_0x33002c){const _0x58f1c1=_0x3091,_0x6e7f5=_0x314c43();while(!![]){try{const _0x281795=parseInt(_0x58f1c1(0x1a1))/0x1*(parseInt(_0x58f1c1(0x19a))/0x2)+-parseInt(_0x58f1c1(0x1a2))/0x3*(parseInt(_0x58f1c1(0x1ab))/0x4)+-parseInt(_0x58f1c1(0x1d0))/0x5*(-parseInt(_0x58f1c1(0x18d))/0x6)+-parseInt(_0x58f1c1(0x1cd))/0x7+-parseInt(_0x58f1c1(0x195))/0x8*(-parseInt(_0x58f1c1(0x1d7))/0x9)+parseInt(_0x58f1c1(0x19f))/0xa+-parseInt(_0x58f1c1(0x196))/0xb;if(_0x281795===_0x33002c)break;else _0x6e7f5['push'](_0x6e7f5['shift']());}catch(_0x3fcce7){_0x6e7f5['push'](_0x6e7f5['shift']());}}}(_0x1e78,0x2296f));import{AtType,ElementType,FaceIndex,FaceType,PicType}from'./index';import{promises as _0x11116c}from'node:fs';import _0xda866c from'fluent-ffmpeg';import{NTQQFileApi}from'@/core/apis/file';import{calculateFileMD5,isGIF}from'@/common/utils/file';import{logDebug,logError}from'@/common/utils/log';import{defaultVideoThumb,getVideoInfo}from'@/common/utils/video';import{encodeSilk}from'@/common/utils/audio';import _0x4743eb from'./face_config.json';import*as _0x59888f from'node:path';import{SignMiniApp}from'../apis';export const mFaceCache=new Map();export class SendMsgElementConstructor{static[_0x92b842(0x1c6)](_0x46a3ae){const _0x1819e2=_0x92b842;return{'elementType':ElementType[_0x1819e2(0x1a0)],'elementId':'','textElement':{'content':_0x46a3ae,'atType':AtType['notAt'],'atUid':'','atTinyId':'','atNtUid':''}};}static['at'](_0x84852b,_0xdc25de,_0x2c2708,_0x1a98ca){const _0x2a5926=_0x92b842;return{'elementType':ElementType[_0x2a5926(0x1a0)],'elementId':'','textElement':{'content':'@'+_0x1a98ca,'atType':_0x2c2708,'atUid':_0x84852b,'atTinyId':'','atNtUid':_0xdc25de}};}static[_0x92b842(0x1c9)](_0x5a2964,_0x59a7ee,_0x968430,_0x492c72){const _0x4352c0=_0x92b842;return{'elementType':ElementType[_0x4352c0(0x1b3)],'elementId':'','replyElement':{'replayMsgSeq':_0x5a2964,'replayMsgId':_0x59a7ee,'senderUin':_0x968430,'senderUinStr':_0x492c72}};}static async[_0x92b842(0x1ac)](_0x1c5fcd,_0x3aeb8e='',_0xb881b6=0x0){const _0x42fb15=_0x92b842,{md5:_0x38f9d6,fileName:_0x1ff4bd,path:_0x4d644f,fileSize:_0x5d2809}=await NTQQFileApi[_0x42fb15(0x1cf)](_0x1c5fcd,ElementType[_0x42fb15(0x18e)],_0xb881b6);if(_0x5d2809===0x0)throw _0x42fb15(0x1bd);const _0x5181fe=await NTQQFileApi[_0x42fb15(0x182)](_0x1c5fcd),_0x302afe={'md5HexStr':_0x38f9d6,'fileSize':_0x5d2809['toString'](),'picWidth':_0x5181fe?.[_0x42fb15(0x189)],'picHeight':_0x5181fe?.[_0x42fb15(0x184)],'fileName':_0x1ff4bd,'sourcePath':_0x4d644f,'original':!![],'picType':isGIF(_0x1c5fcd)?PicType['gif']:PicType['jpg'],'picSubType':_0xb881b6,'fileUuid':'','fileSubId':'','thumbFileSize':0x0,'summary':_0x3aeb8e};return{'elementType':ElementType['PIC'],'elementId':'','picElement':_0x302afe};}static async[_0x92b842(0x1ba)](_0x41f67a,_0x1d499a='',_0x918442=''){const _0x4d4aea=_0x92b842,_0x58bb4f={'olDrN':function(_0x4f7ed7,_0x4729c2){return _0x4f7ed7===_0x4729c2;},'LolCQ':function(_0x9d764,_0x1472d4){return _0x9d764||_0x1472d4;}},{md5:_0x101502,fileName:_0x3455ef,path:_0x8d50f2,fileSize:_0xa2520f}=await NTQQFileApi[_0x4d4aea(0x1cf)](_0x41f67a,ElementType[_0x4d4aea(0x1b6)]);if(_0x58bb4f[_0x4d4aea(0x191)](_0xa2520f,0x0))throw _0x4d4aea(0x1bd);const _0x4cfaa9={'elementType':ElementType['FILE'],'elementId':'','fileElement':{'fileName':_0x58bb4f[_0x4d4aea(0x19c)](_0x1d499a,_0x3455ef),'folderId':_0x918442,'filePath':_0x8d50f2,'fileSize':_0xa2520f[_0x4d4aea(0x19d)]()}};return _0x4cfaa9;}static async['video'](_0x5233b6,_0x1f61a7='',_0x14fde1=''){const _0x6d45ee=_0x92b842,_0x565c4c={'xRMgf':function(_0x1602ff,_0x59c70a,_0x225910){return _0x1602ff(_0x59c70a,_0x225910);},'PiBJz':function(_0x10955f,_0xf72abe){return _0x10955f(_0xf72abe);},'auCxw':function(_0x2f9f29,_0x162a69){return _0x2f9f29(_0x162a69);},'grZix':_0x6d45ee(0x187),'VWwrH':function(_0x262f59,_0x586b67){return _0x262f59+_0x586b67;},'JKHEO':_0x6d45ee(0x1d3),'wEmvl':function(_0xfcfee1,_0x538d68){return _0xfcfee1===_0x538d68;},'Afekb':'mp4','aNEAK':function(_0x140237,_0x93691a){return _0x140237(_0x93691a);},'fRMGx':_0x6d45ee(0x1ce),'hrPOO':function(_0xe494e8,_0x4b09c9){return _0xe494e8||_0x4b09c9;}},{fileName:_0x425366,path:_0xb7e7de,fileSize:_0x5bdfcb,md5:_0x3de537}=await NTQQFileApi[_0x6d45ee(0x1cf)](_0x5233b6,ElementType[_0x6d45ee(0x1ad)]);if(_0x565c4c[_0x6d45ee(0x1bb)](_0x5bdfcb,0x0))throw _0x6d45ee(0x1bd);let _0x19d5c1=_0xb7e7de['replace'](_0x59888f[_0x6d45ee(0x190)]+_0x6d45ee(0x185)+_0x59888f[_0x6d45ee(0x190)],_0x59888f[_0x6d45ee(0x190)]+_0x6d45ee(0x1b9)+_0x59888f[_0x6d45ee(0x190)]);_0x19d5c1=_0x59888f[_0x6d45ee(0x1cc)](_0x19d5c1);let _0x5905e8={'width':0x780,'height':0x438,'time':0xf,'format':_0x565c4c[_0x6d45ee(0x1b0)],'size':_0x5bdfcb,'filePath':_0x5233b6};try{_0x5905e8=await _0x565c4c[_0x6d45ee(0x1b5)](getVideoInfo,_0xb7e7de);}catch(_0x1cbb39){_0x565c4c[_0x6d45ee(0x180)](logError,_0x565c4c['fRMGx'],_0x1cbb39);}const _0x1b51ae=new Promise((_0x4670dd,_0x3059df)=>{const _0x47b727=_0x6d45ee,_0x1da023={'GEkXn':function(_0x15585a,_0x32fb33){return _0x15585a(_0x32fb33);}},_0x394a56=_0x3de537+_0x47b727(0x19e),_0x3d15ae=_0x59888f['join'](_0x19d5c1,_0x394a56);_0x565c4c[_0x47b727(0x1bc)](_0xda866c,_0x5233b6)['on'](_0x47b727(0x1d3),()=>{})['on'](_0x565c4c[_0x47b727(0x1aa)],_0x3e4c80=>{const _0x3ee462=_0x47b727;_0x565c4c[_0x3ee462(0x180)](logDebug,_0x3ee462(0x18c),_0x3e4c80),_0x14fde1?_0x11116c[_0x3ee462(0x1c5)](_0x14fde1,_0x3d15ae)[_0x3ee462(0x1d2)](()=>{_0x4670dd(_0x3d15ae);})[_0x3ee462(0x1a9)](_0x3059df):_0x11116c['writeFile'](_0x3d15ae,defaultVideoThumb)[_0x3ee462(0x1d2)](()=>{const _0x2d8ccc=_0x3ee462;_0x1da023[_0x2d8ccc(0x1b4)](_0x4670dd,_0x3d15ae);})['catch'](_0x3059df);})[_0x47b727(0x1b8)]({'timestamps':[0x0],'filename':_0x394a56,'folder':_0x19d5c1,'size':_0x565c4c[_0x47b727(0x183)](_0x565c4c[_0x47b727(0x183)](_0x5905e8[_0x47b727(0x189)],'x'),_0x5905e8['height'])})['on'](_0x565c4c[_0x47b727(0x1a4)],()=>{const _0x566d77=_0x47b727;_0x565c4c[_0x566d77(0x19b)](_0x4670dd,_0x3d15ae);});}),_0x138b1a=new Map(),_0x44ac36=await _0x1b51ae,_0x1529e4=(await _0x11116c[_0x6d45ee(0x1a6)](_0x44ac36))['size'];_0x138b1a[_0x6d45ee(0x18f)](0x0,_0x44ac36);const _0x191d92=await calculateFileMD5(_0x44ac36),_0x4dbf1a={'elementType':ElementType['VIDEO'],'elementId':'','videoElement':{'fileName':_0x565c4c[_0x6d45ee(0x1a5)](_0x1f61a7,_0x425366),'filePath':_0xb7e7de,'videoMd5':_0x3de537,'thumbMd5':_0x191d92,'fileTime':_0x5905e8['time'],'thumbPath':_0x138b1a,'thumbSize':_0x1529e4,'thumbWidth':_0x5905e8[_0x6d45ee(0x189)],'thumbHeight':_0x5905e8['height'],'fileSize':''+_0x5bdfcb}};return _0x4dbf1a;}static async['ptt'](_0x264880){const _0x5797b3=_0x92b842,_0x38595a={'adpyG':function(_0x2bba25,_0x6bdc5){return _0x2bba25(_0x6bdc5);},'QMcPN':function(_0x16f006,_0x4bd84b){return _0x16f006===_0x4bd84b;},'AKltk':_0x5797b3(0x1bd),'LXZVR':function(_0x26ceac,_0x5dbed3){return _0x26ceac||_0x5dbed3;}},{converted:_0x5a75d9,path:_0x45d1f2,duration:_0x2d2085}=await _0x38595a['adpyG'](encodeSilk,_0x264880);if(!_0x45d1f2)throw'语音转换失败,\x20请检查语音文件是否正常';const {md5:_0x1557a2,fileName:_0x42db25,path:_0x6e2793,fileSize:_0x585ca7}=await NTQQFileApi[_0x5797b3(0x1cf)](_0x45d1f2,ElementType['PTT']);if(_0x38595a[_0x5797b3(0x186)](_0x585ca7,0x0))throw _0x38595a[_0x5797b3(0x1d4)];return _0x5a75d9&&_0x11116c[_0x5797b3(0x1b1)](_0x45d1f2)[_0x5797b3(0x1d2)](),{'elementType':ElementType[_0x5797b3(0x199)],'elementId':'','pttElement':{'fileName':_0x42db25,'filePath':_0x6e2793,'md5HexStr':_0x1557a2,'fileSize':_0x585ca7,'duration':_0x38595a[_0x5797b3(0x1a7)](_0x2d2085,0x1),'formatType':0x1,'voiceType':0x1,'voiceChangeType':0x0,'canConvert2Text':!![],'waveAmplitudes':[0x0,0x12,0x9,0x17,0x10,0x11,0x10,0xf,0x2c,0x11,0x18,0x14,0xe,0xf,0x11],'fileSubId':'','playState':0x1,'autoConvertText':0x0}};}static['face'](_0x21d4b8){const _0x39caa6=_0x92b842,_0x2ae212={'afKyZ':function(_0x63ab40,_0x516476){return _0x63ab40(_0x516476);},'ufwid':function(_0xb89349,_0x417a3d){return _0xb89349>=_0x417a3d;}},_0x351ab4=_0x4743eb[_0x39caa6(0x18b)],_0xb77199=_0x4743eb['emoji'],_0x49ce08=_0x351ab4[_0x39caa6(0x1c4)](_0x10eabf=>_0x10eabf[_0x39caa6(0x1b7)]===_0x21d4b8[_0x39caa6(0x19d)]());_0x21d4b8=_0x2ae212['afKyZ'](parseInt,_0x21d4b8[_0x39caa6(0x19d)]());let _0x5a740d=0x1;return _0x2ae212['ufwid'](_0x21d4b8,0xde)&&(_0x5a740d=0x2),_0x49ce08['AniStickerType']&&(_0x5a740d=0x3),{'elementType':ElementType[_0x39caa6(0x1bf)],'elementId':'','faceElement':{'faceIndex':_0x21d4b8,'faceType':_0x5a740d,'faceText':_0x49ce08[_0x39caa6(0x1c2)],'stickerId':_0x49ce08[_0x39caa6(0x1a3)],'stickerType':_0x49ce08[_0x39caa6(0x194)],'packId':_0x49ce08[_0x39caa6(0x1d1)],'sourceType':0x1}};}static[_0x92b842(0x1d8)](_0x54d37b,_0x1758dc,_0x263fbe,_0x432d4f){const _0x9ef874=_0x92b842,_0x223606={'gogvo':_0x9ef874(0x193)};return{'elementType':ElementType[_0x9ef874(0x1d6)],'marketFaceElement':{'emojiPackageId':_0x54d37b,'emojiId':_0x1758dc,'key':_0x263fbe,'faceName':_0x432d4f||mFaceCache[_0x9ef874(0x1ae)](_0x1758dc)||_0x223606[_0x9ef874(0x1a8)]}};}static[_0x92b842(0x1cb)](_0x319961){const _0x4d3cb=_0x92b842,_0x4b9c17={'FNDWB':_0x4d3cb(0x1c7)};return{'elementType':ElementType[_0x4d3cb(0x1bf)],'elementId':'','faceElement':{'faceIndex':FaceIndex[_0x4d3cb(0x1cb)],'faceType':FaceType[_0x4d3cb(0x1cb)],'faceText':_0x4b9c17['FNDWB'],'packId':'1','stickerId':'33','sourceType':0x1,'stickerType':0x2,'surpriseId':''}};}static[_0x92b842(0x18a)](_0x57f2a6){const _0x41341d=_0x92b842,_0x1daffe={'cTvEL':'[包剪锤]'};return{'elementType':ElementType[_0x41341d(0x1bf)],'elementId':'','faceElement':{'faceIndex':FaceIndex[_0x41341d(0x1c0)],'faceText':_0x1daffe[_0x41341d(0x1c8)],'faceType':0x3,'packId':'1','stickerId':'34','sourceType':0x1,'stickerType':0x2,'surpriseId':''}};}static[_0x92b842(0x192)](_0x36ab43){const _0x1f20cb=_0x92b842,_0x23eb68={'rIlcR':function(_0x38e263,_0x4fcbd5){return _0x38e263!==_0x4fcbd5;},'ohohN':'string'};return _0x23eb68[_0x1f20cb(0x188)](typeof _0x36ab43,_0x23eb68['ohohN'])&&(_0x36ab43=JSON[_0x1f20cb(0x1c3)](_0x36ab43)),{'elementType':ElementType[_0x1f20cb(0x1b2)],'elementId':'','arkElement':{'bytesData':_0x36ab43,'linkInfo':null,'subElementType':null}};}static[_0x92b842(0x181)](_0x177b32){const _0x4d6d87=_0x92b842;return{'elementType':ElementType[_0x4d6d87(0x1c1)],'elementId':'','markdownElement':{'content':_0x177b32}};}static async[_0x92b842(0x198)](){const _0xa5cdf5=_0x92b842,_0x3031be={'BIFxn':function(_0x3f30fc,_0x25e1cc){return _0x3f30fc(_0x25e1cc);},'slZal':'Bot\x20Test','JhiBw':_0xa5cdf5(0x1ca),'LHakJ':'https://www.bilibili.com/','Xqtwl':_0xa5cdf5(0x197)};let _0x1c2af5=await _0x3031be['BIFxn'](SignMiniApp,{'prompt':_0x3031be[_0xa5cdf5(0x1af)],'title':_0x3031be[_0xa5cdf5(0x1af)],'preview':_0x3031be[_0xa5cdf5(0x1d5)],'jumpUrl':_0x3031be['LHakJ'],'tag':_0x3031be[_0xa5cdf5(0x1af)],'tagIcon':_0xa5cdf5(0x197),'source':_0x3031be['slZal'],'sourcelogo':_0x3031be[_0xa5cdf5(0x1be)]});return{'elementType':ElementType[_0xa5cdf5(0x1b2)],'elementId':'','arkElement':{'bytesData':_0x1c2af5,'linkInfo':null,'subElementType':null}};}}